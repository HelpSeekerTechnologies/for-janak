<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operation Lineage Audit â€” Ministry Lineage Sankey</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
  :root {
    --primary-teal: #28bcb8;
    --aqua: #4bc2c3;
    --navy: #103656;
    --light-bg: #f8fffe;
    --text-primary: #1a1a2e;
    --text-secondary: #4a5568;
    --font-primary: 'Inter', 'Segoe UI', system-ui, sans-serif;
    --gradient-primary: linear-gradient(135deg, #28bcb8, #4bc2c3);
    --card-shadow: 0 2px 12px rgba(16, 54, 86, 0.10);
    --border-subtle: #d4eeed;
    --hero-gradient: linear-gradient(135deg, #103656 0%, #1a4a6e 40%, #174260 100%);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: var(--font-primary);
    background: var(--light-bg);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }
  .brand-header {
    background: var(--hero-gradient);
    color: #fff;
    padding: 18px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
  }
  .brand-header h1 { font-size: 1.15rem; font-weight: 600; letter-spacing: 0.3px; }
  .brand-header h1 span { color: var(--primary-teal); }
  .brand-header .subtitle { font-size: 0.82rem; opacity: 0.75; font-weight: 400; }
  .brand-header .brand-right { text-align: right; font-size: 0.78rem; opacity: 0.65; }
  .container { max-width: 1500px; margin: 0 auto; padding: 0 24px 60px; }
  .hero-banner {
    background: var(--hero-gradient);
    margin: 0 -24px;
    padding: 32px 24px 36px;
  }
  .hero-title { text-align: center; color: #fff; margin-bottom: 24px; }
  .hero-title h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
  .hero-title p { font-size: 0.9rem; opacity: 0.7; }
  .hero-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    max-width: 1000px;
    margin: 0 auto;
  }
  .hero-card {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(75, 194, 195, 0.25);
    border-radius: 12px;
    padding: 20px 16px;
    text-align: center;
    backdrop-filter: blur(4px);
    transition: transform 0.2s;
  }
  .hero-card:hover { transform: translateY(-2px); border-color: var(--primary-teal); }
  .hero-card .metric-value { font-size: 2rem; font-weight: 800; color: var(--primary-teal); line-height: 1.1; margin-bottom: 4px; }
  .hero-card .metric-label { font-size: 0.78rem; color: rgba(255,255,255,0.85); line-height: 1.3; }
  .hero-card .metric-sublabel { font-size: 0.68rem; color: rgba(255,255,255,0.5); margin-top: 3px; }
  .section {
    background: #fff;
    border-radius: 12px;
    box-shadow: var(--card-shadow);
    margin-top: 24px;
    overflow: hidden;
  }
  .section-header {
    background: var(--navy);
    color: #fff;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .section-header .section-number {
    background: var(--primary-teal);
    color: var(--navy);
    font-weight: 800;
    font-size: 0.85rem;
    width: 28px; height: 28px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .section-header h3 { font-size: 1.05rem; font-weight: 600; }
  .section-body { padding: 28px 24px; }
  .sankey-container {
    width: 100%;
    overflow-x: auto;
    min-height: 600px;
  }
  .sankey-container svg { display: block; margin: 0 auto; }
  .legend {
    display: flex;
    gap: 24px;
    justify-content: center;
    margin: 20px 0 8px;
    flex-wrap: wrap;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.82rem;
    color: var(--text-secondary);
  }
  .legend-swatch {
    width: 20px; height: 14px;
    border-radius: 3px;
    border: 1px solid rgba(0,0,0,0.1);
  }
  .table-wrap {
    overflow-x: auto;
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    margin-top: 16px;
    max-height: 500px;
    overflow-y: auto;
  }
  table.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.84rem;
  }
  table.data-table thead {
    background: var(--navy);
    color: #fff;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  table.data-table th {
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    white-space: nowrap;
  }
  table.data-table td {
    padding: 8px 12px;
    border-bottom: 1px solid #eef5f4;
  }
  table.data-table tbody tr:hover { background: #f0faf9; }
  table.data-table tbody tr:nth-child(even) { background: #fafefe; }
  table.data-table tbody tr:nth-child(even):hover { background: #edf8f7; }
  .event-badge {
    display: inline-block;
    font-size: 0.72rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 10px;
    text-transform: uppercase;
  }
  .event-badge.rename { background: #e8f4fd; color: #2980b9; }
  .event-badge.transfer { background: #fef0e7; color: #d35400; }
  .event-badge.split { background: #fde8e8; color: #e74c3c; }
  .event-badge.merge { background: #e8f8f0; color: #27ae60; }
  .era-badge {
    display: inline-block;
    font-size: 0.68rem;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 8px;
  }
  .era-badge.pc { background: #e0e0e0; color: #555; }
  .era-badge.ndp { background: #fde8d0; color: #d35400; }
  .era-badge.kenney { background: #d4f4f3; color: #0d7377; }
  .era-badge.smith { background: #c5e8e7; color: #0a5c5f; }
  .sankey-tooltip {
    position: fixed;
    background: var(--navy);
    color: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.82rem;
    max-width: 400px;
    pointer-events: none;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    line-height: 1.5;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .sankey-tooltip.visible { opacity: 1; }
  .sankey-tooltip .tt-title { font-weight: 700; color: var(--primary-teal); margin-bottom: 4px; font-size: 0.88rem; }
  .sankey-tooltip .tt-row { display: flex; justify-content: space-between; gap: 16px; }
  .sankey-tooltip .tt-label { opacity: 0.7; }
  .sankey-tooltip .tt-value { font-weight: 600; }
  .provenance-footer {
    margin-top: 40px;
    background: #fff;
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 20px 24px;
  }
  .provenance-footer h4 {
    font-size: 0.9rem;
    color: var(--navy);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--primary-teal);
  }
  .provenance-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }
  .provenance-item {
    background: var(--light-bg);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    padding: 12px;
  }
  .provenance-item .pv-label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    font-weight: 600;
    margin-bottom: 2px;
  }
  .provenance-item .pv-value { font-size: 0.88rem; color: var(--navy); font-weight: 600; }
  .page-footer {
    text-align: center;
    padding: 24px;
    font-size: 0.78rem;
    color: #8a9aaa;
    border-top: 1px solid var(--border-subtle);
    margin-top: 40px;
  }
  .page-footer strong { color: var(--navy); }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .section { animation: fadeInUp 0.5s ease both; }
  @media (max-width: 900px) {
    .hero-grid { grid-template-columns: 1fr 1fr; }
  }
  @media print {
    body { background: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .brand-header, .hero-banner, .section-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .section { break-inside: avoid; box-shadow: none; border: 1px solid #ddd; }
    .sankey-container { overflow: visible; }
    .no-print { display: none !important; }
    @page { margin: 0.5in; }
  }
</style>
</head>
<body>

<header class="brand-header">
  <div>
    <h1>Operation Lineage Audit &mdash; <span>HelpSeeker Technologies</span></h1>
    <div class="subtitle">Ministry Lineage &amp; Political Era Sankey Diagram</div>
  </div>
  <div class="brand-right">
    Ministry Restructuring Analysis<br>
    PC &rarr; NDP &rarr; UCP-Kenney &rarr; UCP-Smith (May 2025)
  </div>
</header>

<div class="container">
  <div class="hero-banner">
    <div class="hero-title">
      <h2>Alberta Ministry Lineage Across Political Eras</h2>
      <p>Tracking 48 ministry-level restructuring events and $209.4B in grant funding flows</p>
    </div>
    <div class="hero-grid">
      <div class="hero-card">
        <div class="metric-value">66</div>
        <div class="metric-label">Ministry Entities</div>
        <div class="metric-sublabel">Across all political eras</div>
      </div>
      <div class="hero-card">
        <div class="metric-value">$18.2B</div>
        <div class="metric-label">PC Era Funding</div>
        <div class="metric-sublabel">Pre-2015</div>
      </div>
      <div class="hero-card">
        <div class="metric-value">$64.2B</div>
        <div class="metric-label">NDP Era Funding</div>
        <div class="metric-sublabel">2015&ndash;2019</div>
      </div>
      <div class="hero-card">
        <div class="metric-value">$57.0B</div>
        <div class="metric-label">UCP-Kenney Funding</div>
        <div class="metric-sublabel">2019&ndash;2022</div>
      </div>
      <div class="hero-card">
        <div class="metric-value">$48.2B</div>
        <div class="metric-label">UCP-Smith Funding</div>
        <div class="metric-sublabel">2022&ndash;present (May 2025 reorg)</div>
      </div>
    </div>
  </div>

  <!-- Sankey Diagram -->
  <div class="section">
    <div class="section-header">
      <div class="section-number">1</div>
      <h3>Ministry Restructuring Flow &mdash; PC &rarr; NDP &rarr; UCP-Kenney &rarr; Current (May 2025)</h3>
    </div>
    <div class="section-body">
      <div class="legend">
        <div class="legend-item"><div class="legend-swatch" style="background:#95a5a6;"></div> PC Era (pre-2015)</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#e67e22;"></div> NDP Era (2015&ndash;2019)</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#28bcb8;"></div> UCP-Kenney (2019&ndash;2022)</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#1a8a87;"></div> Current / UCP-Smith (May 2025)</div>
      </div>
      <div class="sankey-container" id="sankeyContainer"></div>
    </div>
  </div>

  <!-- Transform Events Table -->
  <div class="section" style="animation-delay: 0.15s;">
    <div class="section-header">
      <div class="section-number">2</div>
      <h3>All Ministry Transform Events &mdash; Complete Registry (48 events)</h3>
    </div>
    <div class="section-body">
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Event ID</th>
              <th>Era</th>
              <th>Type</th>
              <th>Source Ministry</th>
              <th>Target Ministry</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="eventTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Data Provenance Footer -->
  <div class="provenance-footer">
    <h4>Data Provenance</h4>
    <div class="provenance-grid">
      <div class="provenance-item">
        <div class="pv-label">Source</div>
        <div class="pv-value">Neo4j graph: 142 OrgEntity nodes, 66 transform relationships</div>
      </div>
      <div class="provenance-item">
        <div class="pv-label">Query Date</div>
        <div class="pv-value">2026-02-12</div>
      </div>
      <div class="provenance-item">
        <div class="pv-label">Confidence</div>
        <div class="pv-value">HIGH &mdash; all data from verified graph model</div>
      </div>
      <div class="provenance-item">
        <div class="pv-label">Latest Event</div>
        <div class="pv-value">2025-05-16: HEALTH split, EDUCATION rename</div>
      </div>
      <div class="provenance-item">
        <div class="pv-label">Ministry Entities</div>
        <div class="pv-value">66 across 4 political eras</div>
      </div>
      <div class="provenance-item">
        <div class="pv-label">Funding Coverage</div>
        <div class="pv-value">$209.4B across PC, NDP, UCP-Kenney, UCP-Smith</div>
      </div>
    </div>
  </div>

  <div class="page-footer">
    <strong>Operation Lineage Audit</strong> &mdash; HelpSeeker Technologies &copy; 2026<br>
    Generated from Neo4j graph analysis of Alberta Government grants &amp; CRA charity governance data.<br>
    This dashboard is a self-contained HTML artifact. No external data connections required.
  </div>
</div>

<!-- Tooltip -->
<div class="sankey-tooltip" id="sankeyTooltip"></div>

<script>
(function() {
  'use strict';

  var COL_COLORS = ['#95a5a6', '#e67e22', '#28bcb8', '#1a8a87'];
  var COL_LABELS = ['PC ERA (pre-2015)', 'NDP ERA (2015-2019)', 'UCP-KENNEY (2019-2022)', 'CURRENT (May 2025)'];
  var LINK_COLORS = {
    continuation: '#aab',
    rename: '#2980b9',
    transfer: '#d35400',
    split: '#e74c3c',
    merge: '#27ae60'
  };

  var nodes = [{"name": "HEALTH", "col": 0, "funding": 14029209602.619999, "fullName": "HEALTH"}, {"name": "INNOVATION AND ADVANCED ED...", "col": 0, "funding": 3269362040.05, "fullName": "INNOVATION AND ADVANCED EDUCATION"}, {"name": "EDUCATION", "col": 0, "funding": 496403342.9500001, "fullName": "EDUCATION"}, {"name": "HUMAN SERVICES", "col": 0, "funding": 240892148.83999994, "fullName": "HUMAN SERVICES"}, {"name": "INFRASTRUCTURE", "col": 0, "funding": 40340808.89, "fullName": "INFRASTRUCTURE"}, {"name": "CULTURE AND TOURISM", "col": 0, "funding": 39428721.830000006, "fullName": "CULTURE AND TOURISM"}, {"name": "CULTURE", "col": 0, "funding": 38272592.42, "fullName": "CULTURE"}, {"name": "MUNICIPAL AFFAIRS", "col": 0, "funding": 29217402.419999998, "fullName": "MUNICIPAL AFFAIRS"}, {"name": "SENIORS", "col": 0, "funding": 12623657.190000005, "fullName": "SENIORS"}, {"name": "AGRICULTURE AND RURAL DEVE...", "col": 0, "funding": 12181534.34, "fullName": "AGRICULTURE AND RURAL DEVELOPMENT"}, {"name": "ENVIRONMENT AND SUSTAINABL...", "col": 0, "funding": 10208603.0, "fullName": "ENVIRONMENT AND SUSTAINABLE RESOURCE DEVELOPMENT"}, {"name": "JUSTICE AND SOLICITOR GENE...", "col": 0, "funding": 3622500.0, "fullName": "JUSTICE AND SOLICITOR GENERAL"}, {"name": "ABORIGINAL RELATIONS", "col": 0, "funding": 1216694.69, "fullName": "ABORIGINAL RELATIONS"}, {"name": "ENERGY", "col": 0, "funding": 1000000.0, "fullName": "ENERGY"}, {"name": "HEALTH", "col": 1, "funding": 48193669877.08, "fullName": "HEALTH"}, {"name": "ADVANCED EDUCATION", "col": 1, "funding": 10470598578.109997, "fullName": "ADVANCED EDUCATION"}, {"name": "EDUCATION", "col": 1, "funding": 2236043771.2800007, "fullName": "EDUCATION"}, {"name": "COMMUNITY AND SOCIAL SERVI...", "col": 1, "funding": 1028311113.1955752, "fullName": "COMMUNITY AND SOCIAL SERVICES"}, {"name": "INFRASTRUCTURE", "col": 1, "funding": 626027894.1600002, "fullName": "INFRASTRUCTURE"}, {"name": "CULTURE AND TOURISM", "col": 1, "funding": 439929803.4199996, "fullName": "CULTURE AND TOURISM"}, {"name": "SENIORS AND HOUSING", "col": 1, "funding": 427650880.15000045, "fullName": "SENIORS AND HOUSING"}, {"name": "CHILDREN'S SERVICES", "col": 1, "funding": 308722838.9440428, "fullName": "CHILDREN'S SERVICES"}, {"name": "LABOUR", "col": 1, "funding": 225609189.99038225, "fullName": "LABOUR"}, {"name": "ENVIRONMENT AND PARKS", "col": 1, "funding": 83485675.4, "fullName": "ENVIRONMENT AND PARKS"}, {"name": "AGRICULTURE AND FORESTRY", "col": 1, "funding": 55242374.38, "fullName": "AGRICULTURE AND FORESTRY"}, {"name": "ECONOMIC DEVELOPMENT AND T...", "col": 1, "funding": 50456349.0, "fullName": "ECONOMIC DEVELOPMENT AND TRADE"}, {"name": "MUNICIPAL AFFAIRS", "col": 1, "funding": 40964325.9, "fullName": "MUNICIPAL AFFAIRS"}, {"name": "TRANSPORTATION", "col": 1, "funding": 15881850.24, "fullName": "TRANSPORTATION"}, {"name": "INDIGENOUS RELATIONS", "col": 1, "funding": 13528483.49, "fullName": "INDIGENOUS RELATIONS"}, {"name": "STATUS OF WOMEN", "col": 1, "funding": 7350857.63, "fullName": "STATUS OF WOMEN"}, {"name": "HEALTH", "col": 2, "funding": 40482172663.09, "fullName": "HEALTH"}, {"name": "ADVANCED EDUCATION", "col": 2, "funding": 7263817173.199998, "fullName": "ADVANCED EDUCATION"}, {"name": "EDUCATION", "col": 2, "funding": 6869701901.09, "fullName": "EDUCATION"}, {"name": "COMMUNITY AND SOCIAL SERVI...", "col": 2, "funding": 872422556.5699999, "fullName": "COMMUNITY AND SOCIAL SERVICES"}, {"name": "INFRASTRUCTURE", "col": 2, "funding": 744125189.6000003, "fullName": "INFRASTRUCTURE"}, {"name": "CHILDREN'S SERVICES", "col": 2, "funding": 307778459.8899996, "fullName": "CHILDREN'S SERVICES"}, {"name": "SENIORS AND HOUSING", "col": 2, "funding": 147578453.1, "fullName": "SENIORS AND HOUSING"}, {"name": "LABOUR AND IMMIGRATION", "col": 2, "funding": 107318065.54, "fullName": "LABOUR AND IMMIGRATION"}, {"name": "CULTURE AND STATUS OF WOMEN", "col": 2, "funding": 79539456.66, "fullName": "CULTURE AND STATUS OF WOMEN"}, {"name": "AGRICULTURE AND FORESTRY", "col": 2, "funding": 42595576.36, "fullName": "AGRICULTURE AND FORESTRY"}, {"name": "MUNICIPAL AFFAIRS", "col": 2, "funding": 32165742.300000004, "fullName": "MUNICIPAL AFFAIRS"}, {"name": "TRANSPORTATION", "col": 2, "funding": 31763539.399999995, "fullName": "TRANSPORTATION"}, {"name": "ENVIRONMENT AND PARKS", "col": 2, "funding": 31270366.599999998, "fullName": "ENVIRONMENT AND PARKS"}, {"name": "JOBS, ECONOMY AND INNOVATION", "col": 2, "funding": 14342853.530000003, "fullName": "JOBS, ECONOMY AND INNOVATION"}, {"name": "JUSTICE AND SOLICITOR GENE...", "col": 2, "funding": 6650300.0, "fullName": "JUSTICE AND SOLICITOR GENERAL"}, {"name": "INDIGENOUS RELATIONS", "col": 2, "funding": 3536990.0, "fullName": "INDIGENOUS RELATIONS"}, {"name": "HOSPITAL AND SURGICAL HEAL...", "col": 3, "funding": 16390053283.974998, "fullName": "HOSPITAL AND SURGICAL HEALTH SERVICES"}, {"name": "PRIMARY AND PREVENTATIVE H...", "col": 3, "funding": 16390053283.974998, "fullName": "PRIMARY AND PREVENTATIVE HEALTH SERVICES"}, {"name": "EDUCATION AND CHILDCARE", "col": 3, "funding": 6883344571.000008, "fullName": "EDUCATION AND CHILDCARE"}, {"name": "ADVANCED EDUCATION", "col": 3, "funding": 5428998071.200002, "fullName": "ADVANCED EDUCATION"}, {"name": "MENTAL HEALTH AND ADDICTION", "col": 3, "funding": 873486218.21, "fullName": "MENTAL HEALTH AND ADDICTION"}, {"name": "INFRASTRUCTURE", "col": 3, "funding": 710943750.2499999, "fullName": "INFRASTRUCTURE"}, {"name": "ASSISTED LIVING AND SOCIAL...", "col": 3, "funding": 428536316.62, "fullName": "ASSISTED LIVING AND SOCIAL SERVICES"}, {"name": "CHILDREN AND FAMILY SERVICES", "col": 3, "funding": 349815571.02, "fullName": "CHILDREN AND FAMILY SERVICES"}, {"name": "ARTS, CULTURE AND STATUS O...", "col": 3, "funding": 255418763.74999994, "fullName": "ARTS, CULTURE AND STATUS OF WOMEN"}, {"name": "JOBS, ECONOMY, TRADE AND I...", "col": 3, "funding": 155880599.61, "fullName": "JOBS, ECONOMY, TRADE AND IMMIGRATION"}, {"name": "PUBLIC SAFETY AND EMERGENC...", "col": 3, "funding": 55831149.55, "fullName": "PUBLIC SAFETY AND EMERGENCY SERVICES"}, {"name": "SKILLED TRADES AND PROFESS...", "col": 3, "funding": 38742221.5, "fullName": "SKILLED TRADES AND PROFESSIONS"}, {"name": "ENVIRONMENT AND PROTECTED ...", "col": 3, "funding": 33864975.62, "fullName": "ENVIRONMENT AND PROTECTED AREAS"}, {"name": "JUSTICE", "col": 3, "funding": 30426499.0, "fullName": "JUSTICE"}, {"name": "AGRICULTURE AND IRRIGATION", "col": 3, "funding": 29276016.32, "fullName": "AGRICULTURE AND IRRIGATION"}, {"name": "INDIGENOUS RELATIONS", "col": 3, "funding": 23583265.799999997, "fullName": "INDIGENOUS RELATIONS"}, {"name": "ALBERTA SOCIAL HOUSING COR...", "col": 3, "funding": 23428451.25, "fullName": "ALBERTA SOCIAL HOUSING CORPORATION"}, {"name": "MUNICIPAL AFFAIRS", "col": 3, "funding": 19198339.32, "fullName": "MUNICIPAL AFFAIRS"}, {"name": "TOURISM AND SPORT", "col": 3, "funding": 13633804.0, "fullName": "TOURISM AND SPORT"}];
  var links = [{"source": 12, "target": 28, "type": "rename"}, {"source": 9, "target": 24, "type": "rename"}, {"source": 6, "target": 19, "type": "merge"}, {"source": 10, "target": 23, "type": "rename"}, {"source": 1, "target": 15, "type": "rename"}, {"source": 8, "target": 20, "type": "rename"}, {"source": 3, "target": 21, "type": "split"}, {"source": 3, "target": 17, "type": "split"}, {"source": 0, "target": 14, "type": "continuation"}, {"source": 2, "target": 16, "type": "continuation"}, {"source": 4, "target": 18, "type": "continuation"}, {"source": 5, "target": 19, "type": "continuation"}, {"source": 7, "target": 26, "type": "continuation"}, {"source": 22, "target": 37, "type": "rename"}, {"source": 14, "target": 30, "type": "continuation"}, {"source": 15, "target": 31, "type": "continuation"}, {"source": 16, "target": 32, "type": "continuation"}, {"source": 17, "target": 33, "type": "continuation"}, {"source": 18, "target": 34, "type": "continuation"}, {"source": 20, "target": 36, "type": "continuation"}, {"source": 21, "target": 35, "type": "continuation"}, {"source": 23, "target": 42, "type": "continuation"}, {"source": 24, "target": 39, "type": "continuation"}, {"source": 26, "target": 40, "type": "continuation"}, {"source": 27, "target": 41, "type": "continuation"}, {"source": 28, "target": 45, "type": "continuation"}, {"source": 30, "target": 46, "type": "split"}, {"source": 30, "target": 47, "type": "split"}, {"source": 32, "target": 48, "type": "rename"}, {"source": 31, "target": 49, "type": "continuation"}, {"source": 33, "target": 52, "type": "rename"}, {"source": 34, "target": 51, "type": "continuation"}, {"source": 35, "target": 53, "type": "rename"}, {"source": 36, "target": 52, "type": "merge"}, {"source": 37, "target": 57, "type": "split"}, {"source": 37, "target": 55, "type": "split"}, {"source": 38, "target": 54, "type": "rename"}, {"source": 39, "target": 60, "type": "rename"}, {"source": 40, "target": 63, "type": "continuation"}, {"source": 42, "target": 58, "type": "split"}, {"source": 42, "target": 64, "type": "split"}, {"source": 43, "target": 55, "type": "merge"}, {"source": 44, "target": 59, "type": "split"}, {"source": 44, "target": 56, "type": "split"}, {"source": 45, "target": 61, "type": "continuation"}];
  var tableEvents = [{"id": "TE046", "type": "TRANSFER", "source": "ALBERTA SOCIAL HOUSING CORPORATION", "target": "ALBERTA SOCIAL HOUSING CORPORATION", "date": "2015-04-01", "era": "PC"}, {"id": "TE001", "type": "RENAME", "source": "ABORIGINAL RELATIONS", "target": "INDIGENOUS RELATIONS", "date": "2015-10-22", "era": "NDP"}, {"id": "TE003", "type": "RENAME", "source": "AGRICULTURE AND RURAL DEVELOPMENT", "target": "AGRICULTURE AND FORESTRY", "date": "2015-10-22", "era": "NDP"}, {"id": "TE007", "type": "MERGE", "source": "CULTURE", "target": "CULTURE AND TOURISM", "date": "2015-10-22", "era": "NDP"}, {"id": "TE004", "type": "RENAME", "source": "ENVIRONMENT AND SUSTAINABLE RESOURCE DEVELOPMENT", "target": "ENVIRONMENT AND PARKS", "date": "2015-10-22", "era": "NDP"}, {"id": "TE005", "type": "TRANSFER", "source": "ENVIRONMENT AND SUSTAINABLE RESOURCE DEVELOPMENT", "target": "ENERGY", "date": "2015-10-22", "era": "NDP"}, {"id": "TE002", "type": "RENAME", "source": "INNOVATION AND ADVANCED EDUCATION", "target": "ADVANCED EDUCATION", "date": "2015-10-22", "era": "NDP"}, {"id": "TE006", "type": "RENAME", "source": "INTERNATIONAL AND INTERGOVERNMENTAL RELATIONS", "target": "ECONOMIC DEVELOPMENT AND TRADE", "date": "2015-10-22", "era": "NDP"}, {"id": "TE008", "type": "RENAME", "source": "SENIORS", "target": "SENIORS AND HOUSING", "date": "2015-10-22", "era": "NDP"}, {"id": "TE007", "type": "MERGE", "source": "TOURISM", "target": "CULTURE AND TOURISM", "date": "2015-10-22", "era": "NDP"}, {"id": "TE010", "type": "SPLIT", "source": "HUMAN SERVICES", "target": "CHILDREN'S SERVICES", "date": "2016-02-02", "era": "NDP"}, {"id": "TE010", "type": "SPLIT", "source": "HUMAN SERVICES", "target": "COMMUNITY AND SOCIAL SERVICES", "date": "2016-02-02", "era": "NDP"}, {"id": "TE016", "type": "SPLIT", "source": "ECONOMIC DEVELOPMENT AND TRADE", "target": "CULTURE", "date": "2019-04-30", "era": "UCP_Kenney"}, {"id": "TE016", "type": "SPLIT", "source": "ECONOMIC DEVELOPMENT AND TRADE", "target": "ECONOMIC DEVELOPMENT", "date": "2019-04-30", "era": "UCP_Kenney"}, {"id": "TE015", "type": "RENAME", "source": "LABOUR", "target": "LABOUR AND IMMIGRATION", "date": "2019-04-30", "era": "UCP_Kenney"}, {"id": "TE021", "type": "MERGE", "source": "CULTURE", "target": "CULTURE AND STATUS OF WOMEN", "date": "2021-07-08", "era": "UCP_Kenney"}, {"id": "TE021", "type": "MERGE", "source": "ECONOMIC DEVELOPMENT", "target": "CULTURE AND STATUS OF WOMEN", "date": "2021-07-08", "era": "UCP_Kenney"}, {"id": "TE020", "type": "RENAME", "source": "JOBS", "target": "JOBS, ECONOMY AND INNOVATION", "date": "2021-07-08", "era": "UCP_Kenney"}, {"id": "TE048", "type": "TRANSFER", "source": "ALBERTA SOCIAL HOUSING CORPORATION", "target": "ALBERTA SOCIAL HOUSING CORPORATION", "date": "2022-04-01", "era": "UCP_Kenney"}, {"id": "TE027", "type": "RENAME", "source": "AGRICULTURE AND FORESTRY", "target": "AGRICULTURE AND IRRIGATION", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE030", "type": "MERGE", "source": "COMMUNITY AND SOCIAL SERVICES", "target": "SENIORS, COMMUNITY AND SOCIAL SERVICES", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE032", "type": "RENAME", "source": "CULTURE AND STATUS OF WOMEN", "target": "CULTURE", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE025", "type": "SPLIT", "source": "ENERGY", "target": "AFFORDABILITY AND UTILITIES", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE025", "type": "SPLIT", "source": "ENERGY", "target": "ENERGY AND MINERALS", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE024", "type": "SPLIT", "source": "ENVIRONMENT AND PARKS", "target": "ENVIRONMENT AND PROTECTED AREAS", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE024", "type": "SPLIT", "source": "ENVIRONMENT AND PARKS", "target": "FORESTRY, PARKS AND TOURISM", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE029", "type": "SPLIT", "source": "JOBS, ECONOMY AND INNOVATION", "target": "JOBS, ECONOMY AND NORTHERN DEVELOPMENT", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE029", "type": "SPLIT", "source": "JOBS, ECONOMY AND INNOVATION", "target": "TECHNOLOGY AND INNOVATION", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE023", "type": "SPLIT", "source": "JUSTICE AND SOLICITOR GENERAL", "target": "JUSTICE", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE023", "type": "SPLIT", "source": "JUSTICE AND SOLICITOR GENERAL", "target": "PUBLIC SAFETY AND EMERGENCY SERVICES", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE028", "type": "SPLIT", "source": "LABOUR AND IMMIGRATION", "target": "SKILLED TRADES AND PROFESSIONS", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE028", "type": "SPLIT", "source": "LABOUR AND IMMIGRATION", "target": "TRADE, IMMIGRATION AND MULTICULTURALISM", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE030", "type": "MERGE", "source": "SENIORS AND HOUSING", "target": "SENIORS, COMMUNITY AND SOCIAL SERVICES", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE026", "type": "RENAME", "source": "TRANSPORTATION", "target": "TRANSPORTATION AND ECONOMIC CORRIDORS", "date": "2022-10-24", "era": "UCP_Smith"}, {"id": "TE034", "type": "RENAME", "source": "CHILDREN'S SERVICES", "target": "CHILDREN AND FAMILY SERVICES", "date": "2023-06-09", "era": "UCP_Smith"}, {"id": "TE033", "type": "RENAME", "source": "CULTURE", "target": "ARTS, CULTURE AND STATUS OF WOMEN", "date": "2023-06-09", "era": "UCP_Smith"}, {"id": "TE036", "type": "SPLIT", "source": "FORESTRY, PARKS AND TOURISM", "target": "FORESTRY AND PARKS", "date": "2023-06-09", "era": "UCP_Smith"}, {"id": "TE036", "type": "SPLIT", "source": "FORESTRY, PARKS AND TOURISM", "target": "TOURISM AND SPORT", "date": "2023-06-09", "era": "UCP_Smith"}, {"id": "TE038", "type": "RENAME", "source": "JOBS, ECONOMY AND NORTHERN DEVELOPMENT", "target": "JOBS, ECONOMY AND TRADE", "date": "2023-06-09", "era": "UCP_Smith"}, {"id": "TE035", "type": "RENAME", "source": "SERVICE ALBERTA", "target": "SERVICE ALBERTA AND RED TAPE REDUCTION", "date": "2023-06-09", "era": "UCP_Smith"}, {"id": "TE037", "type": "SPLIT", "source": "TRADE, IMMIGRATION AND MULTICULTURALISM", "target": "IMMIGRATION AND MULTICULTURALISM", "date": "2023-06-09", "era": "UCP_Smith"}, {"id": "TE037", "type": "SPLIT", "source": "TRADE, IMMIGRATION AND MULTICULTURALISM", "target": "JOBS, ECONOMY AND TRADE", "date": "2023-06-09", "era": "UCP_Smith"}, {"id": "TE052", "type": "RENAME", "source": "EDUCATION", "target": "EDUCATION AND CHILDCARE", "date": "2025-05-16", "era": "UCP_Smith"}, {"id": "TE050", "type": "SPLIT", "source": "HEALTH", "target": "HOSPITAL AND SURGICAL HEALTH SERVICES", "date": "2025-05-16", "era": "UCP_Smith"}, {"id": "TE050", "type": "SPLIT", "source": "HEALTH", "target": "PRIMARY AND PREVENTATIVE HEALTH SERVICES", "date": "2025-05-16", "era": "UCP_Smith"}, {"id": "TE053", "type": "MERGE", "source": "IMMIGRATION AND MULTICULTURALISM", "target": "JOBS, ECONOMY, TRADE AND IMMIGRATION", "date": "2025-05-16", "era": "UCP_Smith"}, {"id": "TE053", "type": "MERGE", "source": "JOBS, ECONOMY AND TRADE", "target": "JOBS, ECONOMY, TRADE AND IMMIGRATION", "date": "2025-05-16", "era": "UCP_Smith"}, {"id": "TE051", "type": "RENAME", "source": "SENIORS, COMMUNITY AND SOCIAL SERVICES", "target": "ASSISTED LIVING AND SOCIAL SERVICES", "date": "2025-05-16", "era": "UCP_Smith"}];

  // ===== SANKEY LAYOUT =====
  function sankeyLayout(nodes, links, width, height, nodePadding, nodeWidth) {
    var N = nodes.map(function(d, i) {
      return {
        index: i, name: d.name, col: d.col, funding: d.funding,
        fullName: d.fullName,
        value: Math.max(Math.pow(d.funding / 1e6, 0.42), 4),
        x0: 0, x1: 0, y0: 0, y1: 0,
        sourceLinks: [], targetLinks: []
      };
    });
    var L = links.map(function(d, i) {
      return {
        index: i, source: N[d.source], target: N[d.target],
        type: d.type, value: 0, width: 0, y0: 0, y1: 0
      };
    });

    L.forEach(function(link) {
      link.source.sourceLinks.push(link);
      link.target.targetLinks.push(link);
      link.value = link.target.value;
    });

    // Assign x positions by column
    var colSpacing = (width - nodeWidth) / 3;
    N.forEach(function(n) {
      n.x0 = n.col * colSpacing;
      n.x1 = n.x0 + nodeWidth;
    });

    // Group by column, sort by value desc
    var columns = [[], [], [], []];
    N.forEach(function(n) { columns[n.col].push(n); });

    columns.forEach(function(col) {
      col.sort(function(a, b) { return b.value - a.value; });
      var totalValue = d3.sum(col, function(n) { return n.value; });
      var totalPadding = Math.max((col.length - 1) * nodePadding, 0);
      var availableHeight = height - totalPadding;
      var scale = Math.min(availableHeight / Math.max(totalValue, 1), 50);

      var y = 0;
      col.forEach(function(n) {
        n.y0 = y;
        n.y1 = y + Math.max(n.value * scale, 3);
        y = n.y1 + nodePadding;
      });

      // Rescale if overflow
      var last = col[col.length - 1];
      if (last && last.y1 > height) {
        var factor = height / last.y1;
        col.forEach(function(n) {
          n.y0 *= factor;
          n.y1 *= factor;
        });
      }
    });

    // Compute link y positions
    N.forEach(function(node) {
      node.sourceLinks.sort(function(a, b) { return a.target.y0 - b.target.y0; });
      node.targetLinks.sort(function(a, b) { return a.source.y0 - b.source.y0; });
    });

    N.forEach(function(node) {
      var sy = node.y0;
      node.sourceLinks.forEach(function(link) {
        var nodeH = node.y1 - node.y0;
        var linkH = (link.value / Math.max(d3.sum(node.sourceLinks, function(l){ return l.value; }), 1)) * nodeH;
        link.y0 = sy + linkH / 2;
        link.width = Math.max(linkH, 1.5);
        sy += linkH;
      });

      var ty = node.y0;
      node.targetLinks.forEach(function(link) {
        var nodeH = node.y1 - node.y0;
        var linkH = (link.value / Math.max(d3.sum(node.targetLinks, function(l){ return l.value; }), 1)) * nodeH;
        link.y1 = ty + linkH / 2;
        ty += linkH;
      });
    });

    return { nodes: N, links: L };
  }

  function linkPath(d) {
    var x0 = d.source.x1, x1 = d.target.x0;
    var xi = d3.interpolateNumber(x0, x1);
    return 'M' + x0 + ',' + d.y0
      + 'C' + xi(0.5) + ',' + d.y0
      + ' ' + xi(0.5) + ',' + d.y1
      + ' ' + x1 + ',' + d.y1;
  }

  function fmtCurrency(val) {
    if (val >= 1e9) return '$' + (val/1e9).toFixed(1) + 'B';
    if (val >= 1e6) return '$' + (val/1e6).toFixed(0) + 'M';
    return '$' + val.toLocaleString();
  }

  // ===== RENDER SANKEY =====
  var tooltip = document.getElementById('sankeyTooltip');

  function renderSankey() {
    var container = document.getElementById('sankeyContainer');
    container.innerHTML = '';

    var margin = { top: 30, right: 220, bottom: 20, left: 220 };
    var fullWidth = 1440;
    var fullHeight = 750;
    var width = fullWidth - margin.left - margin.right;
    var height = fullHeight - margin.top - margin.bottom;

    var layout = sankeyLayout(nodes, links, width, height, 6, 16);

    var svg = d3.select(container).append('svg')
      .attr('width', fullWidth)
      .attr('height', fullHeight)
      .attr('viewBox', '0 0 ' + fullWidth + ' ' + fullHeight)
      .style('max-width', '100%')
      .style('height', 'auto');

    var g = svg.append('g')
      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    // Era column headers
    var colSpacing = (width - 16) / 3;
    COL_LABELS.forEach(function(label, i) {
      g.append('text')
        .attr('x', i * colSpacing + 8)
        .attr('y', -10)
        .attr('text-anchor', 'middle')
        .attr('font-size', '11px')
        .attr('font-weight', '700')
        .attr('fill', COL_COLORS[i])
        .text(label);
    });

    // Draw links
    g.append('g')
      .attr('fill', 'none')
      .attr('stroke-opacity', 0.3)
      .selectAll('path')
      .data(layout.links)
      .join('path')
      .attr('d', linkPath)
      .attr('stroke', function(d) { return LINK_COLORS[d.type] || '#aab'; })
      .attr('stroke-width', function(d) { return Math.max(d.width, 1.5); })
      .on('mouseenter', function(event, d) {
        d3.select(this).attr('stroke-opacity', 0.7);
        var html = '<div class="tt-title">' + d.source.fullName + ' &rarr; ' + d.target.fullName + '</div>';
        html += '<div class="tt-row"><span class="tt-label">Type:</span> <span class="tt-value">' + d.type.toUpperCase() + '</span></div>';
        html += '<div class="tt-row"><span class="tt-label">Source funding:</span> <span class="tt-value">' + fmtCurrency(d.source.funding) + '</span></div>';
        html += '<div class="tt-row"><span class="tt-label">Target funding:</span> <span class="tt-value">' + fmtCurrency(d.target.funding) + '</span></div>';
        tooltip.innerHTML = html;
        tooltip.classList.add('visible');
      })
      .on('mousemove', function(event) {
        tooltip.style.left = (event.clientX + 14) + 'px';
        tooltip.style.top = (event.clientY - 10) + 'px';
      })
      .on('mouseleave', function() {
        d3.select(this).attr('stroke-opacity', 0.3);
        tooltip.classList.remove('visible');
      });

    // Draw nodes
    var nodeSel = g.append('g').selectAll('g')
      .data(layout.nodes)
      .join('g');

    nodeSel.append('rect')
      .attr('x', function(d) { return d.x0; })
      .attr('y', function(d) { return d.y0; })
      .attr('width', function(d) { return d.x1 - d.x0; })
      .attr('height', function(d) { return Math.max(d.y1 - d.y0, 2); })
      .attr('fill', function(d) { return COL_COLORS[d.col]; })
      .attr('rx', 2)
      .on('mouseenter', function(event, d) {
        var html = '<div class="tt-title">' + d.fullName + '</div>';
        html += '<div class="tt-row"><span class="tt-label">Era:</span> <span class="tt-value">' + COL_LABELS[d.col] + '</span></div>';
        html += '<div class="tt-row"><span class="tt-label">Total grants:</span> <span class="tt-value">' + fmtCurrency(d.funding) + '</span></div>';
        tooltip.innerHTML = html;
        tooltip.classList.add('visible');
      })
      .on('mousemove', function(event) {
        tooltip.style.left = (event.clientX + 14) + 'px';
        tooltip.style.top = (event.clientY - 10) + 'px';
      })
      .on('mouseleave', function() {
        tooltip.classList.remove('visible');
      });

    // Node labels
    nodeSel.append('text')
      .attr('x', function(d) {
        if (d.col === 3) return d.x1 + 6;
        if (d.col === 0) return d.x0 - 6;
        return d.x0 + (d.x1 - d.x0) / 2;
      })
      .attr('y', function(d) { return (d.y0 + d.y1) / 2; })
      .attr('dy', '0.35em')
      .attr('text-anchor', function(d) {
        if (d.col === 3) return 'start';
        if (d.col === 0) return 'end';
        return 'middle';
      })
      .attr('font-size', '8.5px')
      .attr('font-weight', '600')
      .attr('fill', function(d) {
        if (d.col === 1 || d.col === 2) {
          return (d.y1 - d.y0) > 12 ? '#fff' : 'var(--text-primary)';
        }
        return 'var(--text-primary)';
      })
      .each(function(d) {
        var label = d.name;
        if (label.length > 30) label = label.substring(0, 28) + '...';
        if ((d.col === 1 || d.col === 2) && (d.y1 - d.y0) < 12) {
          d3.select(this)
            .attr('x', d.x1 + 6)
            .attr('text-anchor', 'start')
            .attr('fill', 'var(--text-primary)');
        }
        d3.select(this).text(label);
      });
  }

  // ===== RENDER EVENT TABLE =====
  function renderEventTable() {
    var tbody = document.getElementById('eventTableBody');
    tbody.innerHTML = '';
    tableEvents.forEach(function(ev) {
      var badgeClass = ev.type.toLowerCase();
      var eraClass = ev.era === 'PC' ? 'pc' : ev.era === 'NDP' ? 'ndp' : ev.era === 'UCP_Kenney' ? 'kenney' : 'smith';
      var eraLabel = ev.era === 'UCP_Kenney' ? 'Kenney' : ev.era === 'UCP_Smith' ? 'Smith' : ev.era;
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td style="font-weight:700;color:var(--navy);">' + ev.id + '</td>' +
        '<td><span class="era-badge ' + eraClass + '">' + eraLabel + '</span></td>' +
        '<td><span class="event-badge ' + badgeClass + '">' + ev.type + '</span></td>' +
        '<td>' + ev.source + '</td>' +
        '<td>' + ev.target + '</td>' +
        '<td>' + ev.date + '</td>';
      tbody.appendChild(tr);
    });
  }

  // ===== INIT =====
  renderSankey();
  renderEventTable();
})();
</script>

</body>
</html>